{% extends "../dashboard.html" %}
{% load static %}
{% block content %}

<!-- Add this once at the bottom of your base template or here -->
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<style>
  footer {
    display: none;
  }
  /* Highlight selected tweet */
  input[type="radio"]:checked + .media {
    border: 2px solid #3273dc;
    border-radius: 6px;
    padding: 0.5em;
  }
  
  /* Default label style */
  .custom-radio-label {
    border: 1px solid #ccc;
    border-radius: 6px;
    transition: background-color 0.2s ease-in-out;
    cursor: pointer;
  }
  /* cover */
  .cover {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color:transparent;
    z-index: 1;
  }
  /* Change background when selected */
  label.custom-radio-label:has(input[type="radio"]:checked) {
    background-color: #ffd83cbf;
    border-color: #ffd83c;
  }
  .floater-container {
    position: relative;
    display: block;
    width: 100%;
  }
  .floater-container form {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .left-scroller {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    padding-right: 10px; /* Add some padding to prevent content from touching the scrollbar */
  }
  .toast-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background-color: #363636;
    color: #fff;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
  }
  #preview-card {
    background-color: transparent !important;
    border:1px solid #ccc;
    box-shadow: none !important;
  }
  #generated-text {
    background-color: #fff !important;
    border:1px solid #ccc;
    box-shadow: none !important;
  }
  @keyframes slideIn {
    from {
      transform: translateX(-50%) translateY(-10px);
      opacity: 0;
    }
    to {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
</style>


<section class="section p-5">
  <div class="container">
    <div class="columns is-variable is-8">
      <div class="column is-half">
        <h1 class="title has-text-centered">Pitch Reply Generator</h1>
        <div class="floater-container">
          <form id="reply-form" method="post">
            {% csrf_token %}
  
            <!-- Pitch Selector -->
            <div class="field">
              <label class="label">Your Product/Tool</label>
              <p class="help">Select the product/tool you want to pitch</p>
              <div class="control">
                <div class="select is-fullwidth">
                  <select name="pitch_id" required style="background-color: transparent;">
                    <option value="" disabled selected>Select a product/tool‚Ä¶</option>
                    {% for pitch in claimed_pitches %}
                    <option value="{{ pitch.id }}">{{ pitch.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            <!-- hidden input to take tweet content -->
            <input type="hidden" name="tweet_content" id="tweet_content">  
            <input type="hidden" name="tweet_url" id="tweet_url">  
            <!-- Extra Ideas -->
            <div class="field">
              <label class="label">Additional Ideas</label>
              <div class="control">
                <textarea 
                  style="background-color: transparent;"  
                  name="extra_ideas" 
                  class="textarea" 
                  rows="3"
                  cols="30"
                  required = 'false'
                  placeholder="E.g. mention analytics, highlight free trial, tone etc"></textarea>
              </div>
            </div>
  
            <!-- Generate Button -->
            <div class="field mt-5">
              <div class="control">
                <button
                  type="submit"
                  class="button is-warning"
                  id="generate-btn">
                  <span class="icon"><i class="fas fa-magic"></i></span>
                  <span>Generate Pitch</span>
                </button>
              </div>
            </div>
          </form>
        </div>
        
      <!-- Generated Preview -->
      <div id="preview-card" class="card mt-6 has-background-transparent" style="display: none;">
        <div class="card-content">
          <h2 class="subtitle">Generated Pitches</h2>
          <div id="tweet-content" class="mt-3"></div>
          <div class="my-2">
            <a href="#" id="tweet-url-button">View Tweet 
              <span class="icon"><i class="fas fa-external-link-alt"></i></span>
            </a>
          </div>
          <div class="box" id="generated-text" style="white-space: pre-wrap;"></div>
          <div class="buttons mt-4">            
            <button  class="button is-link" id="tweet-button" data-tweet-url="">              
              <span class="icon"><i class="far fa-copy"></i></span>
              <span clas="icon">Copy & Reply to ùïè</span>
            </button>
          </div>
        </div>
      </div>
      </div>
      <div class="column is-half" style="padding-top:22px;">
        <h2 class="subtitle">Choose a Post to Reply To</h2>
        <div class="left-scroller">
          {% for post in reply_opportunities %}
          <label class="custom-radio-label radio is-block mb-3 p-4 ml-0">
            <input type="radio" name="tweet_content" 
                   value="{{ post.url }}" 
                   data-content="{{ post.content }}"
                   onclick="
                    document.getElementById('tweet_content').value = this.dataset.content;
                    document.getElementById('tweet_url').value = this.value;
                    ">
            <div class="cover"></div>
            <div class="label-content">
              {{ post.embeded|safe }}
            </div>
          </label>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast-notification" class="toast-notification has-background-warning has-text-black" style="display:none;">
  Reply copied! X will open for you to reply.
</div>

<script>
  var tweet_button = document.getElementById('tweet-button');
  var toast_notification = document.getElementById('toast-notification');
  // Close toast after 3 seconds
  toast_notification.addEventListener('click', function() {
    toast_notification.style.display = 'none';
    toast_notification.textContent = "";
  });
  tweet_button.addEventListener('click', function() {
    if (!this.dataset.tweet_url && !document.getElementById('generated-text').textContent) {
      toast_notification.textContent = "Please select a tweet to reply to before copying and tweeting.";
      toast_notification.style.display = 'block';
      return;
    }
    navigator.clipboard.writeText(document.getElementById('generated-text').textContent);
    toast_notification.textContent = "Copied to clipboard! X will open for you to  in 3 seconds.";
    toast_notification.style.display = 'block';
    // Wait 3 seconds and Open X
    var url = this.dataset.tweet_url;
    setTimeout(function() {
      window.open(url, '_blank');
    }, 3000);
  });
  document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('generate-btn');
    btn.classList.add('is-loading');

    const form = e.target;
    const payload = {
      tweet_content: form.tweet_content.value,
      tweet_url: form.tweet_url.value,
      pitch_id: form.pitch_id.value,
      extra_ideas: form.extra_ideas.value,
    };
    if (!payload.tweet_content && !payload.tweet_url) {
      toast_notification.textContent = "Please select a tweet to reply to before generating your pitch.";
      toast_notification.style.display = 'block';
      btn.classList.remove('is-loading');
      return;
    } 
    console.log(payload);

    const resp = await fetch("{% url 'generate_tweet_pitch' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify(payload),
    });
    
    btn.classList.remove('is-loading');
    const data = await resp.json();
    console.log( payload.tweet_url);
    if (data.content) {
      document.getElementById('generated-text').textContent = data.content;
      document.getElementById('preview-card').style.display = 'block';
      document.getElementById('tweet-content').textContent = payload.tweet_content;
      document.getElementById('tweet-button').dataset.tweet_url = payload.tweet_url;
    }
  });

// Copy & Tweet handlers (same as before)...
</script>



{% endblock content %}

